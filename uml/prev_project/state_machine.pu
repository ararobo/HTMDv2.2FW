@startuml
    [*] --> HardwareInit : "Power On"
    
    state HardwareInit {
        [*] --> InitGPIO
        InitGPIO --> InitPWM
        InitPWM --> InitCAN
    }

    HardwareInit --> ConfigWait : "App Setup Complete"

    state ConfigWait {
        [*] --> ReadDIPSwitch : "Get Dev ID"
        ReadDIPSwitch --> WaitForCANConfig : "ID Assigned"
        WaitForCANConfig --> ConfigReceived : "CAN Init Config Rx"
    }

    ConfigWait --> Idle : "Config Loaded"

    state MainLoop {
        state Idle {
            [*] --> BrakeOn
            BrakeOn --> Ready
        }

        state ControlRun {
            ReadSensors --> UpdateTarget
            UpdateTarget --> CalcTrapezoid
            CalcTrapezoid --> CalcPID
            CalcPID --> DriveGate
        }

        state LimitStop {
            [*] --> StopPWM
            StopPWM --> HoldPosition
        }

        Idle --> ControlRun : "Target Received (!= 0)"
        ControlRun --> Idle : "Target == 0"
        ControlRun --> LimitStop : "Limit Switch Triggered"
        
        LimitStop --> ControlRun : "Reverse Cmd Received"
        ControlRun --> ControlRun : "Period Elapsed (1ms)"
    }