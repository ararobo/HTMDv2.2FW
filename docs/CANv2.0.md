# CAN通信 v2.0
CAN IDやデータフレームを定義し、その際のモータードライバーの動きも記載する。

# IDについて
IDには、bit毎に役割を設けております。
多くのデバイスを干渉すること無く使用することが考慮されており、また、通信方向が区別されるため、CAN通信にフィルタをかけることが可能です。 
bit毎の割り当てを下記に記します。

|bit|名称|内容|詳細|
|:-:|:-:|:-:|:-:|
|1~3|data_type|データの種類を示す|各基板毎に違うので、基板毎の資料を確認すること|
|4~7|board_id|同じ種類の基板を区別|0~15個の基板を同じCANBUS内で扱える(MD_idに等しい)|
|8~10|board_type|基板の種類を示す|0~7の値に基板が割り当てられる|
|11|direction|通信方向|0:Main基板からMD等の制御値、1:MD等からMain基板へのフィードバック|

## direction（通信方向）
0 or 1で通信方向を示す。
|値|方向|説明|
|:-:|:-:|:-:|
|0|master → slave|メイン基板から周辺基板への送信|
|1|slave → master|周辺基板からメイン基板へのフィードバック|

## board_type（基板の種類）
0~7で基板の種類を表す。
|値|名称|説明|
|:-:|:-:|:-:|
|0|ems|非常停止基板|
|1|md|モータードライバー基板|
|2|servo|サーボモータードライバー基板|
|3|solenoid|電磁弁制御基板|
|4|未定|未定|
|5|未定|未定|
|6|未定|未定|
|7|未定|未定|

## data_type（Emergency Stopの場合）
|data_type|名称|サイズ[byte]|dir:0の時の内容|dir:1の時の内容|
|:-:|:-:|:-:|:-:|:-:|
|0|init|1|非常停止の設定|通信チャンネル|
|1|status|2|未使用|1byte目：通信状況（0:未接続、1:不安定、2:安定）、2byte目：接続数|
|2|emergency_stop|1|非常停止の状態を設定（0:解除、1:非常停止）|現在の非常停止の状態（0:解除、1:非常停止）|

## data_type (MDの場合)
|data_type|名称|サイズ[byte]|dir:0の時の内容|dir:1の時の内容|
|:-:|:-:|:-:|:-:|:-:|
|0|init|8/1|MDの設定（サイズ:8byte）|基板の種類（サイズ:1byte）|
|1|target|2|モーター１つの制御値|エンコーダーの値|
|2|limit_switch|1|未使用|リミットスイッチの状態(bit毎にSW1, SW2...SW8)|
|3|gain|5|1バイト: ゲイン種別 (0=P, 1=I, 2=D) + 4バイト: float値|現在のゲイン値|

## data_type（servoの場合）
|data_type|名称|サイズ[byte]|dir:0の時の内容|dir:1の時の内容|
|:-:|:-:|:-:|:-:|:-:|
|0|init|1|サーボドライバーの設定|現在のサーボドライバーの設定|
|1|target|2|出力PWMのduty|未使用|
|2|frequency|2|出力PWMの周波数|未使用|

## data_type（solenoidの場合）
|data_type|名称|サイズ[byte]|dir:0の時の内容|dir:1の時の内容|
|:-:|:-:|:-:|:-:|:-:|
|0|init|1|固定値:0|基板の種類|
|1|target|1|各bitに1つの電磁弁の出力|未使用|

# データフレーム

- [MDのデータフレーム](can_v2.0_md_dataframe.md)

# データ管理用クラス

- [MDのデータ管理用クラス](can_v2.0_md_class.md)