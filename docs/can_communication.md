# MDのCAN通信

## IDについて
IDには、bit毎に役割を設けております。
多くのデバイスを干渉すること無く使用することが考慮されており、また、通信方向が区別されるため、CAN通信にフィルタをかけることが可能です。 
bit毎の割り当てを下記に記します。

|bit|名称|内容|詳細|
|:-:|:-:|:-:|:-:|
|1~3|data_type|データの種類を示す|各基板毎に違うので、基板毎の資料を確認すること|
|4~7|board_id|同じ種類の基板を区別|0~15個の基板を同じCANBUS内で扱える(MD_idに等しい)|
|8~10|board_type|基板の種類を示す|0~7の値に基板が割り当てられる|
|11|direction|通信方向|0:Main基板からMD等の制御値、1:MD等からMain基板へのフィードバック|

### data_type (MD)
以下の表のようにMDではdata_typeを活用する。

|data_type|名称|サイズ[byte]|dir:0の時の意味|dir:1の時の意味|
|:-:|:-:|:-:|:-:|:-:|
|0|init|8|MDの設定|基板の種類|
|1|target|2|モーター１つの制御値|エンコーダーの値|
|2|limit_switch|1|※１リミットスイッチが押されたときの振る舞い|リミットスイッチの状態(bit毎にSW1, SW2...SW8)|
|3|gain|5|1バイト: ゲイン種別 (0=P, 1=I, 2=D) + 4バイト: float値|現在のゲイン値|

※１リミットスイッチが押されたときの振る舞い
- 0:何もしない
- 1:制御値がゼロになるまで出力をゼロにする
- 2:正回転を停止
- 3:逆回転を停止
- 4:正回転をスイッチ１で停止,逆回転をスイッチ２で停止

## データフレームについて
若干data_typeの説明に被ってしまうが、ここではデータフレームに重きを置いて説明する。

### init
このデータを送らないとモーターは回らない。
以下に内容を記載する。

#### dir:0 モータードライバーの設定が含まれる。
|名称|サイズ|型|説明|
|:-:|:-:|:-:|:-:|
|max_output|2byte|uint16_t|最大出力 duty|
|max_acceleration|1byte|uint8_t|台形制御の最大加速 duty/ms|
|control_period|1byte|uint8_t|制御周期 ms|
|brake|1byte|bool|制御値が0の時、ブレーキをかけるか（推奨：true）falseで自然減速|
|encoder_period|1byte|uint8_t|エンコーダーのサンプリング周期（0でエンコーダー無効）ms|
|encoder_type|1byte|bool|エンコーダーの種類(false:インクリメンタル, true:アブソリュート)|
|pid_control|1byte|bool|PID制御を有効化|


#### dir:1 モータードライバー基板の種類が含まれる。
uint8_tで、
|値|MDの種類|
|:-:|:-:|
|0|YamaMDv4|
|1|YamaMDv5|
|2|HTMDv1.5|
|3|HTMDv2.2c|
|4|HTMDv2.2s|
|5|ikeda_MD|